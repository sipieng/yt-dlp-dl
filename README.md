# yt-dlp Web UI

** 使用 AI 开发。仅在 Windows 11 下测试通过。**
基于Flask的Web界面，为yt-dlp提供图形化操作界面。支持解析视频格式、选择下载质量、自定义文件名等功能。

## 待办

[ ] 选择一条视频加两条音频，默认得到的结果无论是mp4还是mkv都只有一条视频和一条音频。（优先级：低）
[ ] 下载路径可自定义。（优先级：中）
[ ] 自定义选择的音视频流与封装格式不符时（如选择了把 opus 音频封装入 mp4）自动调用 ffmpeg 转码。（优先级：低）

## 功能特性

1. **URL解析**：输入视频URL，自动获取所有可用格式（视频、音频、字幕）
2. **下载模式**：
   - **默认最佳质量**：自动选择最佳画质和音质（yt-dlp默认逻辑）
   - **自定义选择**：手动选择具体的视频、音频、字幕或合并格式
3. **下载选项**：
   - 自定义文件名（留空使用视频原标题）
   - 选择输出容器格式（MP4/MKV/WebM或自动选择）
   - 下载路径配置（默认：`./downloads/`）
4. **实时进度**：显示下载进度、速度和预计完成时间
5. **文件管理**：下载完成后可打开下载文件夹
6. **智能防覆盖**：重复下载自动重命名，避免覆盖旧文件

## 系统要求

- Python 3.13+
- yt-dlp 2025.12.8+
- Flask 3.0+

## 安装与运行

### 1. 安装依赖

项目使用[UV](https://github.com/astral-sh/uv)管理Python依赖。确保已安装UV，然后运行：

```bash
# 同步依赖（会自动安装Flask和yt-dlp）
uv sync
```

### 2. 启动Web UI

```bash
# 方法1：直接运行批处理文件（Windows）
run.bat

# 方法2：直接运行Python脚本
uv run run.py
```

### 3. 访问Web界面

服务器启动后，在浏览器中打开：  
👉 **[http://127.0.0.1:5000](http://127.0.0.1:5000)**

## 使用指南

### 基本流程

1. **输入视频URL**
   - 在输入框中粘贴YouTube或其他支持网站的视频链接

2. **解析格式**
   - 点击"解析格式"按钮
   - 系统将获取视频信息和所有可用格式
   - 解析成功后显示视频标题、时长和格式数量

3. **选择下载模式**
   - **自定义选择**（默认）：手动选择具体的视频、音频、字幕或合并格式
   - **默认最佳质量**：自动选择最佳画质和音质（yt-dlp默认逻辑）

4. **配置下载选项**
   - 自定义文件名（可选）
   - 下载路径（默认：`%USERPROFILE%/downloads/`）
   - 容器格式（自动/MP4/MKV/WebM）

5. **开始下载**
   - 点击"开始下载"按钮
   - 系统将在后台下载视频
   - 页面显示实时进度、下载速度和预计完成时间

6. **完成下载**
   - 下载完成后显示"下载完成"消息
   - 点击"打开下载文件夹"按钮查看下载的视频

### 界面详解

#### 1. URL输入区
- 输入框：粘贴视频链接
- 解析按钮：获取视频信息和格式列表
- 清空按钮：重置当前选择

#### 2. 视频信息区（解析后显示）
- 视频标题
- 时长和格式数量统计

#### 3. 格式选择区（自定义模式）
- **统一表格显示**：所有格式类型（视频/音频/合并/字幕）在同一表格中显示
- **格式类型标识**：通过颜色标签区分不同格式类型
- **多选支持**：可同时选择多个格式进行下载

#### 4. 下载选项区
- **文件名**：自定义输出文件名（不含扩展名）
- **下载路径**：文件保存目录
- **容器格式**：输出文件格式

#### 5. 状态显示区
- 进度条：实时显示下载进度
- 状态消息：当前操作状态

## 技术架构

### 项目结构
```
yt-dlp-dl/
├── app.py                    # Flask主应用
├── run.py                    # 启动脚本
├── run.bat                   # Windows启动脚本
├── services/
│   └── downloader.py         # yt-dlp下载器服务
├── templates/
│   └── index.html           # 主界面模板
├── static/
│   ├── css/
│   │   └── style.css        # 样式表
│   └── js/
│       └── script.js        # 前端交互逻辑
├── downloads/               # 下载文件存储目录
├── .gitignore              # Git忽略规则
├── pyproject.toml          # 项目配置
├── uv.lock                 # 依赖锁定
├── README.md               # 原始命令行使用说明
└── README_WEBUI.md         # Web UI使用说明（本文档）
```

### 后端API端点

| 端点 | 方法 | 功能 |
|------|------|------|
| `/` | GET | 渲染主页面 |
| `/api/parse` | POST | 解析URL，返回视频信息和格式列表 |
| `/api/download` | POST | 启动下载任务 |
| `/api/status/<task_id>` | GET | 查询下载任务状态 |
| `/downloads/<filename>` | GET | 下载已完成的文件 |
| `/health` | GET | 健康检查 |

### 前端技术
- **HTML5**：页面结构
- **CSS3**：响应式设计，现代化界面
- **JavaScript (ES6)**：异步交互，实时更新
- **无框架依赖**：原生实现，轻量高效

## 常见问题

### Q1: 解析视频时显示JavaScript运行时警告
```
WARNING: [youtube] No supported JavaScript runtime could be found...
```
**原因**：yt-dlp需要JavaScript运行时来解析某些YouTube格式。  
**解决方案**：安装一个JS运行时（如Deno）：
```bash
# 安装Deno（推荐）
uv add deno

# 或者使用已有Node.js
uv add nodejs
```
**注意**：即使没有JS运行时，大部分视频仍可正常下载，只是可能缺少某些格式。

### Q2: 文件保存位置
下载的文件默认保存在 `%USERPROFILE%/downloads/` 目录下。  
可在Web界面中修改下载路径，或直接在服务器文件系统中访问该目录。

### Q3: 同时下载多个视频
当前版本设计为**单任务下载**，一次只能处理一个下载任务。  
这是为了防止服务器资源过载。下载完成后可开始新任务。

### Q4: 支持哪些视频网站？
支持所有yt-dlp支持的网站，包括：
- YouTube
- Bilibili
- 小红书
- 抖音
- Twitter
- TikTok
- 等1000+个网站

## 注意事项

1. **版权提醒**：请仅下载您有权下载的视频内容，遵守相关法律法规。
2. **资源使用**：视频下载会占用网络带宽和服务器存储空间。
3. **文件保留**：下载的文件永久保留在 `%USERPROFILE%/downloads/` 目录中，请定期清理。
4. **单任务限制**：同时只允许一个下载任务，避免服务器过载。

## 故障排除

### 无法启动Flask服务器
```bash
# 检查Python版本
python --version

# 检查依赖是否安装
uv pip list | grep -E "(flask|yt-dlp)"

# 检查端口占用
netstat -ano | findstr :5000  # Windows
lsof -i :5000                 # macOS/Linux
```

### 无法解析某些视频
```bash
# 更新yt-dlp到最新版本
uv add yt-dlp -U

# 检查视频URL是否有效
```

### 下载进度不更新
- 刷新页面重新连接
- 检查浏览器控制台是否有JavaScript错误
- 重启Flask服务器

## 更新日志

### v1.1.0 (2025-02-04)
- **支持合并音视频流的平台（如小红书）**
  - 统一表格显示所有格式类型（视频/音频/合并/字幕）
  - 添加 `format_type` 字段和 `has_separate_streams` 标志
  - 支持多选格式，用户可自由选择任意组合
  - 移除标签页切换，简化用户操作

- **防止文件覆盖 - 自动重命名**
  - 重复下载同一链接时自动添加数字后缀（如 `_2`, `_3`）
  - 支持自定义文件名和默认文件名两种情况

- **"打开下载文件夹"功能**
  - 将"下载文件"按钮改为"打开下载文件夹"
  - 支持 Windows/macOS/Linux 系统
  - 使用非阻塞方式打开文件夹

- **优化加载提示位置**
  - 将"正在解析视频信息"提示移到"1. 输入视频URL"模块下方
  - 用户无需滚动页面即可查看解析状态

- **Bug修复**
  - 修复格式计数显示错误（显示"0 个可用格式"）
  - 修复重复下载失败问题（不刷新页面直接解析新URL）
  - 修复双重"下载失败"提示问题

- **错误提示优化**
  - 错误消息位置优化：移到"1. 输入视频URL"模块下方
  - 错误消息持久显示：移除自动隐藏，一直保留直到用户操作
  - 修复错误消息不显示bug

- **解析结果清空逻辑**
  - 新解析前自动清空旧结果，避免误导用户
  - 清空按钮智能显示：根据URL输入框内容自动显示/隐藏

- **默认设置调整**
  - 默认选中"自定义选择"模式
  - 解析成功后自动显示格式列表

- **界面优化**
  - "类型"列宽度调整：从80px增加到100px
  - 时长格式优化：从 `M:SS` 改为 `HH:MM:SS.xxx` 格式

### v1.0.0 (2025-02-02)
- 初始版本发布
- 基本视频解析和下载功能
- 默认/自定义下载模式
- 实时进度显示
- 响应式Web界面

## 许可证

本项目基于MIT许可证开源。详见LICENSE文件。
